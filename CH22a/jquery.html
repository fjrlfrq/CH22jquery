<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css"
        integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <link rel="stylesheet" href="./public/stylesh/style.css">
    <link rel="stylesheet" href="./public/fontawesome/css/all.css">
    <script src="./moment.min.js"></script>
    <script src="./jquery-3.6.3.min.js"></script>
    <title>BREAD</title>
</head>

<body>

    <div class="card">

        <div class="card-header">
            <marquee behavior="ALTERNATE" scrollamount="8">
                <h2>BREAD (Browse,Read,Edit,Add,Delete)</h2>
            </marquee>
        </div>

        <div class="card-body">
            <div class="container">
                <form class="form-horizontal" id="search-form">
                    <input type="hidden" id="idc" value="">
                    <div class="form-group">
                        <label class="col-sm-2" for="stringc">
                            <input type="checkbox" name="stringc" id="stringc"> String
                        </label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" placeholder="String" name="strings" id="strings">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2" for="integerc">
                            <input type="checkbox" name="integerc" id="integerc"> Integer
                        </label>
                        <div class="col-sm-10">
                            <input type="integer" class="form-control" placeholder="Integer" name="integers"
                                id="integers">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2" for="floatc">
                            <input type="checkbox" name="floatc" id="floatc"> Float
                        </label>
                        <div class="col-sm-10">
                            <input type="real" class="form-control" placeholder="Float" name="floats" id="floats">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2" for="datenc">
                            <input type="checkbox" name="datenc" id="datenc"> Date
                        </label>
                        <div class="col-sm-10">
                            <input type="date" class="form-control" placeholder="date" name="datens" id="datens">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2" for="booleanc">
                            <input type="checkbox" name="booleanc" id="booleanc"> Boolean
                        </label>
                        <div class="col-sm-10">
                            <input type="boolean" class="form-control" placeholder="Choose the boolean.."
                                name="booleans" id="booleans">
                        </div>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-info"><i class="fa-solid fa-magnifying-glass"></i></button>
                        <a href="/" class="btn btn-warning"><i class="fa-solid fa-rotate-left"></i></a>
                    </div>
                </form>
            </div>
        </div>

        <div class="card-body">
            <div class="container">
                <form class="form-horizontal" id="user-form">
                    <input type="hidden" id="id" value="">
                    <div class="form-group">
                        <label class="col-sm-2">
                            String
                        </label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" placeholder="String" name="string" id="string">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2">
                            Integer
                        </label>
                        <div class="col-sm-10">
                            <input type="integer" class="form-control" placeholder="Integer" name="integer"
                                id="integer">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2">
                            Float
                        </label>
                        <div class="col-sm-10">
                            <input type="real" class="form-control" placeholder="Float" name="float" id="float">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2">
                            Date
                        </label>
                        <div class="col-sm-10">
                            <input type="date" class="form-control" placeholder="date" name="daten" id="daten">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2">
                            Boolean
                        </label>
                        <div class="col-sm-10">
                            <input type="boolean" class="form-control" placeholder="Choose the boolean.." name="boolean"
                                id="boolean">
                        </div>
                    </div>
                    <div class="col-sm-6" style="position: flex; text-align: start; padding-top:5mm">
                        <a href="/" class="btn btn-warning"><i class="fa-solid fa-rotate-left"></i></a>
                    </div>
                    <div class="col-sm-6" style="position: flex; text-align: end; padding-top:5mm">
                        <button type="submit" class="btn btn-info"><i class="fa-solid fa-download"></i></button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card-body">
            <div class="container" style="padding-top: 0.5rem;">
                <table class="table table-striped" style="text-align: center;">
                    <thead id="sort-tab">

                    </thead>
                    <tbody id="users-body">

                    </tbody>
                </table>

                <div style="position: flex; text-align: center;">
                    <nav>
                        <ul class="pagination pagination-lg" id="pagination-body">

                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <script>

        $(document).ready(function () {

            readData()

            $("#user-form").submit(function (event) {
                event.preventDefault()
                const id = $('#id').value
                const string = $('#string').val()
                const integer = $('#integer').val()
                const float = $('#float').val()
                const daten = $('#daten').val()
                const boolean = $('#boolean').val()
                saveData(id, string, integer, float, daten, boolean)

            });
        })

        $("#search-form").submit(function (event) {
            event.preventDefault()
            const page = 1
            const strings = $('#strings').val()
            const stringc = $('#stringc').val()
            const integers = $('#integers').val()
            const integerc = $('#integerc').val()
            const floats = $('#floats').val()
            const floatc = $('#floatc').val()
            const datens = $('#datens').val()
            const datenc = $('#datenc').val()
            const booleans = $('#booleans').val()
            const booleanc = $('#booleanc').val()
            params = {
                ...params,
                strings, stringc,
                integers, integerc,
                floats, floatc,
                datens, datenc,
                booleans, booleanc,
                page,
            }
            readData(params);

        });

        $("#stringc").change(function () {
            if (this.checked) {
                console.log(this.value);
            } else {
                console.log('ini else', this.value);
            }
        })

        let params = {};

        const changePage = (page) => {
            params = { ...params, page }
            readData(params)
            return false
        }

        const changeSort = (sortBy, sortMode) => {
            params = { ...params, sortBy, sortMode }
            readData(params)
            return false
        }

        //read
        const readData = (params) => {
            $.ajax({
                method: "GET",
                url: `http://localhost:3000/users/?${new URLSearchParams(params).toString()}`
            }).done(function ({ data, page, pages, offset, sortBy, sortMode }) {
                params = { ...params, page, pages, offset, sortBy, sortMode }
                let html = ""
                data.forEach((item, index) => {
                    html += `
                    <tr>
                        <td>${index + 1 + offset}</td>
                        <td>${item.string}</td>
                        <td>${item.integer}</td>
                        <td>${item.float}</td>
                        <td>${moment(item.daten).format("DD MMMM YYYY")}</td>
                        <td>${item.boolean}</td>
                        <td>
                            <button type="button" class="btn btn-success" onclick="editData('${item._id}')"><i class="fa-solid fa-pen" onclick="editData('${item._id}')"></i></button>
                            <button type="button" class="btn btn-danger" onclick="removeData('${item._id}')"><i class="fa-solid fa-trash" onclick="removeData('${item._id}')"></i></button>
                        </td>
                    </tr>`
                });
                $('#users-body').html(html)
                pagination(params);
                sorting(params)
            }).fail(function (err) {
                alert("Error: " + err)
            })
        }

        //pagination
        const pagination = (params) => {
            let li = "";

            let beforePages = params.page - 1;
            let afterPages = params.page + 1;
            let liActive;

            if (params.page >= 1) {
                li += `
                <li class="page-item ${params.page == 1 ? "disabled" : ""}">
                    <a class="page-link" href="javascript:void(0)" onclick="changePage(${params.page - 1})">Previous</a>
                </li>`
            }

            for (let i = beforePages; i <= afterPages; i++) {
                if (i > params.pages) {
                    continue;
                }

                if (i == 0) {
                    i = i + 1
                }

                if (params.page == i) {
                    liActive = "active";
                } else {
                    liActive = ""
                }

                li += `
                <li class="page-item ${liActive}">
                    <a class="page-link" href="javascript:void(0)" onclick="changePage(${(i)})">
                        ${i}
                    </a>    
                </li>`
            }

            if (params.page <= params.pages) {
                li += `
                <li class="page-item ${params.page == params.pages ? "disabled" : ""}">
                    <a class="page-link" href="javascript:void(0)" onclick="changePage(${params.page + 1})">Next</a>    
                </li>`
            }

            document.getElementById("pagination-body").innerHTML = li;
        }

        //sorting
        const sorting = (params) => {
            let tr = "";

            tr += `
            <tr>
                <th>No</th>
                <th>
                    <a href="javascript:void(0)" onclick="changeSort('string','${params.sortMode == "asc" ? (sortMode = "desc") : (sortMode = "asc")}')">String &nbsp
                        <i class="fa-solid fa-${params.sortBy == "string" ? params.sortMode == "asc" ? "sort-up" : "sort-down" : "sort"}"></i>
                </th>
                <th>
                    <a href="javascript:void(0)" onclick="changeSort('integer','${params.sortMode == "asc" ? (sortMode = "desc") : (sortMode = "asc")}')">Integer &nbsp
                        <i class="fa-solid fa-${params.sortBy == "integer" ? params.sortMode == "asc" ? "sort-up" : "sort-down" : "sort"}"></i> 
                </th>
                <th>
                    <a href="javascript:void(0)" onclick="changeSort('float','${params.sortMode == "asc" ? (sortMode = "desc") : (sortMode = "asc")}')">Float &nbsp
                        <i class="fa-solid fa-${params.sortBy == "float" ? params.sortMode == "asc" ? "sort-up" : "sort-down" : "sort"}"></i> 
                </th>
                <th>
                    <a href="javascript:void(0)" onclick="changeSort('daten','${params.sortMode == "asc" ? (sortMode = "desc") : (sortMode = "asc")}')">Date &nbsp
                        <i class="fa-solid fa-${params.sortBy == "daten" ? params.sortMode == "asc" ? "sort-up" : "sort-down" : "sort"}"></i> 
                </th>
                <th>
                    <a href="javascript:void(0)" onclick="changeSort('boolean','${params.sortMode == "asc" ? (sortMode = "desc") : (sortMode = "asc")}')">Boolean &nbsp
                        <i class="fa-solid fa-${params.sortBy == "boolean" ? params.sortMode == "asc" ? "sort-up" : "sort-down" : "sort"}"></i> 
                </th>
                <th>Actions</th>
            </tr>`

            document.getElementById("sort-tab").innerHTML = tr
        }


        //add & edit
        const saveData = (id, string, integer, float, daten, boolean) => {
            let url = 'http://localhost:3000/users'
            let method = 'POST'
            if (id) {
                url = `http://localhost:3000/users/${id}`
                method = 'PUT'
            }
            $.ajax({
                method,
                url,
                body: JSON.stringify({ id, string, integer, float, daten, boolean })
            }).done(function (data) {
                $('#id').val('')
                $('#string').val('')
                $('#integer').val('')
                $('#float').val('')
                $('#daten').val('')
                $('#boolean').val('')
                readData()

            }).fail(function (err) {
                alert("Error: " + err)
            })
        }

        //edit
        const editData = (id) => {
            $.ajax({
                method: "GET",
                url: `http://localhost:3000/users/${id}`
            }).done(function (data) {
                $('#id').val(data._id)
                $('#string').val(data.string)
                $('#integer').val(data.integer)
                $('#float').val(data.float)
                $('#daten').val(moment(data.daten).format("YYYY-MM-DD"))
                $('#boolean').val(data.boolean)
            }).fail(function (err) {
                alert("Error: " + err)
            })
        }

        //hapus 
        const removeData = (id) => {
            if (confirm('anda yakin?')) {
                $.ajax({
                    method: "DELETE",
                    url: `http://localhost:3000/users/${id}`
                }).done(function (data) {
                    readData()
                }).fail(function (err) {
                    alert("Error: " + err)
                })
            }
        }
    </script>

</body>

</html>